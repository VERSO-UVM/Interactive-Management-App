{% extends 'base.html' %}
{% import "bootstrap/wtf.html" as wtf %}

{% block title %}
Result Page
{% endblock %}

{% block styles %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/result.css') }}">
  <!-- Include Cytoscape.js library -->
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://dagrejs.github.io/project/dagre-d3/latest/dagre-d3.js"></script>
  <script src="https://dagrejs.github.io/project/dagre-d3/latest/dagre-d3.min.js"></script>
  <!-- Include canvg library for rendering SVG on canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/canvg/3.0.0/canvg.min.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .grid-container {
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .resultPage {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    svg {
      width: 95%;
      height: 95%;
      position: relative; /* Ensure SVG is positioned relative for absolute children */
    }

    .clusters rect {
      fill: none;
      stroke-width: 2px;
    }

    text {
      font-weight: 300;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-size: 20px;
    }

    .node rect {
      stroke: #999;
      fill: #fff;
      stroke-width: 1.5px;
    }

    .edgePath path {
      stroke: black;
      stroke-width: 4px;
    }

    .button {
      position: absolute;
      bottom: 20px;
      right: 20px;
    }
  </style>
{% endblock %}

{% block content %}
<div class="grid-container">
  <div class="resultPage">
    <svg id="diagram">
      <!-- SVG content will be dynamically generated -->
    </svg>
  </div>
</div>

<!-- Button to save diagram as PNG -->
<div class="button">
  <button id="imgg" onclick="saveImage()">Download Visual</button>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() { 
    var g = new dagreD3.graphlib.Graph({compound:true})
      .setGraph({ rankdir: 'LR'})
      .setDefaultEdgeLabel(function() { return {}; });

    $.get('/nameList', function(listOfNames) {
      for (var i = 0; i < listOfNames.length; i++) {
        var text = String(listOfNames[i]);
        var newText = text.length > 50 ? text.match(/.{1,50}/g).join('\n') : text;
        g.setNode(i, {label: newText});
      }

      $.get('/matrixInfo', function(matrixInformation) {
        for (var keys in matrixInformation) {
          g.setNode(keys + '_groups', {});
        }

        for (var key in matrixInformation) {
          for (var i = 0; i < matrixInformation[key].length; i++) {
            g.setParent(matrixInformation[key][i], key + '_groups');
          }
        }

        $.get('/confusionList', function(edgeInfo) {
          for (var i = 0; i < edgeInfo.length; i += 2) {
            g.setEdge(String(edgeInfo[i]), String(edgeInfo[i + 1]));
          }

          g.nodes().forEach(function(v) {
            var node = g.node(v);
            node.rx = node.ry = 5;
          });

          var render = new dagreD3.render();
          var svg = d3.select("svg#diagram"),
              svgGroup = svg.append("g");

          render(d3.select("svg#diagram g"), g);

          var scaleRate = (window.innerWidth / g.graph().width) * 0.95;
          var xCenterOffset = (window.innerWidth - g.graph().width * scaleRate) / 2;
          var yCenterOffset = (window.innerHeight - g.graph().height * scaleRate) / 2;

          svgGroup.attr("transform", "translate(" + xCenterOffset + ", " + yCenterOffset + ") scale(" + scaleRate + ")");

          svg.call(d3.zoom().on("zoom", function() {
            svgGroup.attr("transform", d3.event.transform);
          }));

          svg.attr("height", window.innerHeight);
          svg.attr("width", window.innerWidth);
        });
      });
    });
  });

  window.addEventListener('resize', function() {
    d3.select("svg#diagram").attr("height", window.innerHeight).attr("width", window.innerWidth);
  });

  function saveImage() {
  }
</script>
{% endblock %}
